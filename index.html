<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>VeloMatch | Premium v4</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root { --bg: #000; --card: #1c1c1e; --primary: #adff2f; --secondary: #2c2c2e; --text: #fff; --text-dim: #8e8e93; --accent: #ff3b30; }
        body { font-family: -apple-system, sans-serif; background: var(--bg); color: var(--text); margin: 0; height: 100vh; display: flex; flex-direction: column; overflow: hidden; }
        
        /* Modal Login */
        .modal { position: fixed; inset: 0; background: var(--bg); z-index: 10000; display: flex; align-items: center; justify-content: center; padding: 20px; }
        .login-card { background: var(--card); padding: 40px; border-radius: 35px; width: 100%; max-width: 350px; text-align: center; border: 1px solid #333; }
        
        input, select { width: 100%; padding: 16px; margin: 10px 0; border-radius: 18px; border: 1px solid #333; background: #000; color: #fff; box-sizing: border-box; outline: none; }
        .btn-main { width: 100%; padding: 16px; background: var(--primary); border: none; border-radius: 18px; font-weight: 800; color: #000; cursor: pointer; margin-top: 15px; }

        /* Estructura App */
        header { padding: 20px; display: flex; justify-content: space-between; align-items: center; background: rgba(0,0,0,0.8); backdrop-filter: blur(10px); }
        .view { display: none; flex-grow: 1; overflow-y: auto; padding: 20px; padding-bottom: 100px; }
        .view.active { display: block; }
        #map { height: 350px; border-radius: 25px; background: #111; margin-bottom: 15px; border: 1px solid #2c2c2e; }

        /* Cards Historial y Market */
        .item-card { background: var(--card); border-radius: 20px; padding: 15px; margin-bottom: 15px; border: 1px solid #2c2c2e; }
        .history-card { border-left: 5px solid var(--primary); }
        .market-card img { width: 100%; height: 180px; object-fit: cover; border-radius: 15px; }

        /* NavegaciÃ³n */
        .nav-bar { position: fixed; bottom: 20px; left: 5%; width: 90%; height: 70px; background: rgba(28,28,30,0.95); backdrop-filter: blur(20px); border-radius: 35px; display: flex; justify-content: space-around; align-items: center; border: 1px solid rgba(255,255,255,0.1); z-index: 1000; }
        .nav-item { background: none; border: none; color: var(--text-dim); font-size: 1.3rem; cursor: pointer; }
        .nav-item.active { color: var(--primary); }

        .rec-label { background: var(--accent); color: #fff; padding: 10px; border-radius: 15px; text-align: center; font-weight: bold; margin-bottom: 10px; display: none; }
    </style>
</head>
<body>

<div id="login-modal" class="modal">
    <div class="login-card">
        <i class="fas fa-bicycle" style="font-size: 3rem; color: var(--primary);"></i>
        <h1>VeloMatch</h1>
        <input type="text" id="user-name" placeholder="Tu nombre">
        <select id="user-country">
            <option value="Argentina">ðŸ‡¦ðŸ‡· Argentina</option>
            <option value="MÃ©xico">ðŸ‡²ðŸ‡½ MÃ©xico</option>
            <option value="EspaÃ±a">ðŸ‡ªðŸ‡¸ EspaÃ±a</option>
            <option value="Colombia">ðŸ‡¨ðŸ‡´ Colombia</option>
        </select>
        <button class="btn-main" id="btn-login">COMENZAR</button>
    </div>
</div>

<header><b>VELOMATCH</b> <span id="tag-user" style="color:var(--primary); font-size: 0.8rem;"></span></header>

<main>
    <section id="map-view" class="view active">
        <div id="rec-alert" class="rec-label">ðŸ”´ GRABANDO: <span id="dist-count">0.0</span> KM</div>
        <div id="map"></div>
        <div style="display: flex; gap: 10px;">
            <button class="btn-main" id="btn-gps" style="flex:1"><i class="fas fa-location-arrow"></i> GPS</button>
            <button class="btn-main" id="btn-rec" style="flex:1; background:#fff;"><i class="fas fa-play"></i> GRABAR</button>
        </div>
    </section>

    <section id="market-view" class="view">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom:15px;">
            <h2>Market</h2>
            <button onclick="toggleForm()" style="color:var(--primary); background:none; border:none; font-weight:bold;">+ Vender</button>
        </div>
        <div id="m-form" style="display:none; background:var(--secondary); padding:15px; border-radius:20px; margin-bottom:20px;">
            <input type="text" id="m-t" placeholder="Producto">
            <input type="text" id="m-p" placeholder="Precio">
            <input type="text" id="m-i" placeholder="URL Foto">
            <button class="btn-main" id="btn-post">PUBLICAR</button>
        </div>
        <div id="market-list"></div>
    </section>

    <section id="history-view" class="view">
        <h2>Mis Rutas</h2>
        <div id="history-list"></div>
    </section>

    <section id="chat-view" class="view">
        <div id="chat-box" style="height: 60vh; overflow-y: auto; display: flex; flex-direction: column; gap: 10px;"></div>
        <div style="display:flex; gap:10px; margin-top:15px;">
            <input type="text" id="chat-in" placeholder="Escribe..." style="margin:0;">
            <button id="btn-chat" class="btn-main" style="margin:0; width:60px;"><i class="fas fa-paper-plane"></i></button>
        </div>
    </section>
</main>

<nav class="nav-bar">
    <button class="nav-item active" onclick="nav('map-view', this)"><i class="fas fa-map"></i></button>
    <button class="nav-item" onclick="nav('market-view', this)"><i class="fas fa-shopping-cart"></i></button>
    <button class="nav-item" onclick="nav('history-view', this)"><i class="fas fa-history"></i></button>
    <button class="nav-item" onclick="nav('chat-view', this)"><i class="fas fa-comment"></i></button>
</nav>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getDatabase, ref, set, push, onValue, onChildAdded } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

    const firebaseConfig = {
        apiKey: "AIzaSyDux5GjU7Nbtok8d_uZ5HVMCYKuSiXHHCQ",
        databaseURL: "https://velomachone-default-rtdb.firebaseio.com",
        projectId: "velomachone"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    let myUser, myCountry, map, markers = {}, routePoints = [], isRec = false, totalKm = 0, currentPath;

    document.getElementById('btn-login').onclick = () => {
        myUser = document.getElementById('user-name').value;
        myCountry = document.getElementById('user-country').value;
        if(!myUser) return alert("Nombre requerido");
        document.getElementById('login-modal').style.display = 'none';
        document.getElementById('tag-user').innerText = myUser;
        initApp();
    };

    function initApp() {
        map = L.map('map', { zoomControl: false }).setView([0,0], 2);
        L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png').addTo(map);
        setTimeout(() => map.invalidateSize(), 500);

        // Cargar Historial Personal
        onChildAdded(ref(db, 'history/' + myUser), (snap) => {
            const r = snap.val();
            const card = `<div class="item-card history-card">
                <b>Ruta de ${r.date}</b><br>
                <span style="color:var(--primary)">${r.dist} KM recorridos</span>
            </div>`;
            document.getElementById('history-list').insertAdjacentHTML('afterbegin', card);
        });

        // Cargar Market
        onChildAdded(ref(db, 'market/'), (snap) => {
            const p = snap.val();
            const card = `<div class="item-card market-card">
                <img src="${p.img || 'https://images.unsplash.com/photo-1485965120184-e220f721d03e?w=400'}">
                <h3>${p.title}</h3>
                <span style="color:var(--primary); font-weight:bold;">$${p.price}</span>
            </div>`;
            document.getElementById('market-list').insertAdjacentHTML('afterbegin', card);
        });

        // Cargar Chat
        onChildAdded(ref(db, 'chat/'), (snap) => {
            const m = snap.val();
            document.getElementById('chat-box').innerHTML += `<div style="background:var(--secondary); padding:10px; border-radius:15px;"><b>${m.user}:</b> ${m.text}</div>`;
        });
    }

    // GPS & GRABACIÃ“N
    document.getElementById('btn-gps').onclick = function() {
        navigator.geolocation.watchPosition(p => {
            const pos = [p.coords.latitude, p.coords.longitude];
            set(ref(db, 'users/' + myUser), { lat: pos[0], lng: pos[1], country: myCountry });
            map.setView(pos, 16);
            if(!markers[myUser]) markers[myUser] = L.circleMarker(pos, {color: '#adff2f', radius: 8}).addTo(map);
            else markers[myUser].setLatLng(pos);

            if(isRec) {
                routePoints.push(pos);
                if(!currentPath) currentPath = L.polyline(routePoints, {color: '#adff2f'}).addTo(map);
                else currentPath.setLatLngs(routePoints);
                if(routePoints.length > 1) {
                    totalKm += map.distance(routePoints[routePoints.length-2], pos) / 1000;
                    document.getElementById('dist-count').innerText = totalKm.toFixed(2);
                }
            }
        }, null, {enableHighAccuracy: true});
        this.innerText = "GPS ACTIVO";
    };

    document.getElementById('btn-rec').onclick = function() {
        isRec = !isRec;
        if(isRec) {
            this.innerHTML = '<i class="fas fa-stop"></i> PARAR';
            this.style.background = 'var(--accent)';
            this.style.color = '#fff';
            document.getElementById('rec-alert').style.display = 'block';
            routePoints = []; totalKm = 0;
        } else {
            // GUARDAR EN HISTORIAL
            if(totalKm > 0.01) {
                const date = new Date().toLocaleDateString();
                push(ref(db, 'history/' + myUser), { date, dist: totalKm.toFixed(2) });
                alert("Ruta guardada en historial");
            }
            this.innerHTML = '<i class="fas fa-play"></i> GRABAR';
            this.style.background = '#fff';
            this.style.color = '#000';
            document.getElementById('rec-alert').style.display = 'none';
            if(currentPath) map.removeLayer(currentPath);
        }
    };

    // NAV
    window.nav = (id, btn) => {
        document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
        document.querySelectorAll('.nav-item').forEach(b => b.classList.remove('active'));
        document.getElementById(id).classList.add('active');
        btn.classList.add('active');
        if(id === 'map-view') setTimeout(() => map.invalidateSize(), 200);
    };

    window.toggleForm = () => {
        const f = document.getElementById('m-form');
        f.style.display = f.style.display === 'none' ? 'block' : 'none';
    };

    document.getElementById('btn-post').onclick = () => {
        const title = document.getElementById('m-t').value;
        const price = document.getElementById('m-p').value;
        const img = document.getElementById('m-i').value;
        push(ref(db, 'market/'), { title, price, img, user: myUser });
        toggleForm();
    };

    document.getElementById('btn-chat').onclick = () => {
        const i = document.getElementById('chat-in');
        if(i.value) { push(ref(db, 'chat/'), { user: myUser, text: i.value }); i.value = ""; }
    };
</script>
</body>
</html>
