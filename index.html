<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VeloMatch v3 Final</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        :root { --bg: #0d0d0d; --card: #1a1a1a; --primary: #adff2f; --accent: #ff4757; --text: #ffffff; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); color: var(--text); margin: 0; height: 100vh; display: flex; flex-direction: column; overflow: hidden; }
        
        /* Modales */
        .modal { position: fixed; inset: 0; background: var(--bg); z-index: 10000; display: flex; align-items: center; justify-content: center; padding: 20px; }
        .box { background: var(--card); padding: 30px; border-radius: 20px; width: 100%; max-width: 340px; text-align: center; border: 1px solid #333; }
        
        input, select { width: 100%; padding: 12px; margin: 8px 0; border-radius: 10px; border: 1px solid #444; background: #000; color: #fff; box-sizing: border-box; }
        .btn { width: 100%; padding: 12px; border: none; border-radius: 10px; font-weight: bold; cursor: pointer; margin-top: 5px; }
        .btn-p { background: var(--primary); color: #000; }
        .btn-s { background: #333; color: #fff; }

        /* Vistas */
        .view { display: none; flex-grow: 1; overflow-y: auto; padding: 15px; padding-bottom: 90px; }
        .view.active { display: block; }
        
        #map { height: 350px; border-radius: 15px; background: #111; margin-bottom: 10px; width: 100%; border: 1px solid #333; }
        
        /* Marketplace */
        .p-card { background: var(--card); border-radius: 15px; padding: 12px; margin-bottom: 12px; border: 1px solid #222; }
        .p-card img { width: 100%; height: 150px; object-fit: cover; border-radius: 10px; }

        .nav { position: fixed; bottom: 0; width: 100%; height: 70px; background: #111; display: flex; justify-content: space-around; align-items: center; border-top: 1px solid #222; }
        .nav-i { background: none; border: none; color: #555; font-size: 1.2rem; cursor: pointer; }
        .nav-i.active { color: var(--primary); }
    </style>
</head>
<body>

<div id="login-modal" class="modal">
    <div class="box">
        <i class="fas fa-bicycle" style="font-size: 3rem; color: var(--primary);"></i>
        <h2>VeloMatch</h2>
        <input type="text" id="user-name" placeholder="Tu nombre">
        <select id="user-country">
            <option value="Argentina">ðŸ‡¦ðŸ‡· Argentina</option>
            <option value="MÃ©xico">ðŸ‡²ðŸ‡½ MÃ©xico</option>
            <option value="EspaÃ±a">ðŸ‡ªðŸ‡¸ EspaÃ±a</option>
            <option value="Colombia">ðŸ‡¨ðŸ‡´ Colombia</option>
        </select>
        <button class="btn btn-p" id="login-exec">INICIAR SESIÃ“N</button>
    </div>
</div>

<header style="padding: 15px; border-bottom: 1px solid #222; display: flex; justify-content: space-between; background: var(--card);">
    <b style="color: var(--primary);">VELOMATCH</b>
    <span id="label-name">Invitado</span>
</header>

<main>
    <section id="map-view" class="view active">
        <div id="map"></div>
        <div style="display: flex; gap: 10px;">
            <button id="gps-exec" class="btn btn-p" style="flex:1">ACTIVAR GPS</button>
            <button id="rec-exec" class="btn btn-s" style="flex:1">GRABAR</button>
        </div>
    </section>

    <section id="market-view" class="view">
        <button class="btn btn-p" id="toggle-form-btn">+ PUBLICAR VENTA</button>
        <div id="m-form" style="display:none; margin-top:15px; background:var(--card); padding:15px; border-radius:15px; border: 1px solid var(--primary);">
            <input type="text" id="m-t" placeholder="Producto">
            <input type="text" id="m-p" placeholder="Precio">
            <input type="text" id="m-i" placeholder="URL Imagen (opcional)">
            <button class="btn btn-p" id="save-market-exec">Publicar Ahora</button>
        </div>
        <div id="market-list" style="margin-top: 20px;"></div>
    </section>

    <section id="chat-view" class="view">
        <div id="chat-content" style="height: 300px; overflow-y: auto; background:#000; padding:15px; border-radius:15px;"></div>
        <div style="display:flex; gap:10px; margin-top:10px;">
            <input type="text" id="chat-i" placeholder="Escribe...">
            <button class="btn btn-p" id="send-chat-exec" style="width: 70px;">âž¤</button>
        </div>
    </section>
</main>

<nav class="nav">
    <button class="nav-i active" id="btn-v-map"><i class="fas fa-map"></i></button>
    <button class="nav-i" id="btn-v-market"><i class="fas fa-store"></i></button>
    <button class="nav-i" id="btn-v-chat"><i class="fas fa-comments"></i></button>
</nav>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getDatabase, ref, set, push, onValue, onChildAdded } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

    const firebaseConfig = {
        apiKey: "AIzaSyDux5GjU7Nbtok8d_uZ5HVMCYKuSiXHHCQ",
        databaseURL: "https://velomachone-default-rtdb.firebaseio.com",
        projectId: "velomachone",
        storageBucket: "velomachone.firebasestorage.app",
        messagingSenderId: "993309414321",
        appId: "1:993309414321:web:52d72f0b635bf48bec2390"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    let myName, myCountry, map, markers = {};

    // 1. LOGIN
    document.getElementById('login-exec').onclick = () => {
        myName = document.getElementById('user-name').value;
        myCountry = document.getElementById('user-country').value;
        if(!myName) return alert("Ingresa tu nombre");
        
        document.getElementById('login-modal').style.display = 'none';
        document.getElementById('label-name').innerText = myName;
        
        initMap();
        syncData();
    };

    function initMap() {
        if(!map) {
            map = L.map('map', { zoomControl: false }).setView([0,0], 2);
            L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png').addTo(map);
            setTimeout(() => map.invalidateSize(), 400);
        }
    }

    // 2. CORRECCIÃ“N GPS (ActivaciÃ³n manual forzada)
    document.getElementById('gps-exec').onclick = function() {
        console.log("Intentando activar GPS...");
        if (!navigator.geolocation) return alert("Tu navegador no soporta GPS");

        this.innerText = "LOCALIZANDO...";
        
        navigator.geolocation.getCurrentPosition(p => {
            const lat = p.coords.latitude;
            const lng = p.coords.longitude;
            
            // Guardar en Firebase
            set(ref(db, 'users/' + myName), { lat, lng, country: myCountry });
            
            // Centrar mapa
            map.setView([lat, lng], 15);
            if(!markers[myName]) {
                markers[myName] = L.circleMarker([lat, lng], { color: '#adff2f', radius: 10 }).addTo(map);
            }
            this.innerText = "GPS ACTIVO";
            this.style.background = "white";
        }, err => {
            alert("ERROR GPS: Por favor activa la ubicaciÃ³n en los ajustes de tu celular/navegador.");
            this.innerText = "REINTENTAR GPS";
        }, { enableHighAccuracy: true });
    };

    // 3. MARKETPLACE (CorrecciÃ³n de PublicaciÃ³n)
    document.getElementById('toggle-form-btn').onclick = () => {
        const f = document.getElementById('m-form');
        f.style.display = f.style.display === 'none' ? 'block' : 'none';
    };

    document.getElementById('save-market-exec').onclick = () => {
        const title = document.getElementById('m-t').value;
        const price = document.getElementById('m-p').value;
        const img = document.getElementById('m-i').value || 'https://images.unsplash.com/photo-1485965120184-e220f721d03e?w=400';

        if(!title || !price) return alert("Llena los campos");

        const newPostRef = push(ref(db, 'market/'));
        set(newPostRef, {
            title,
            price,
            img,
            user: myName,
            likes: 0
        }).then(() => {
            alert("Â¡Publicado con Ã©xito!");
            document.getElementById('m-form').style.display = 'none';
        }).catch(e => alert("Error al publicar: " + e));
    };

    // 4. SINCRONIZACIÃ“N
    function syncData() {
        // Cargar Productos
        onChildAdded(ref(db, 'market/'), (data) => {
            const p = data.val();
            const card = document.createElement('div');
            card.className = 'p-card';
            card.innerHTML = `
                <img src="${p.img}">
                <h3>${p.title}</h3>
                <p style="color:var(--primary)">$${p.price} | <small>Por: ${p.user}</small></p>
            `;
            document.getElementById('market-list').prepend(card);
        });

        // Cargar Usuarios en mapa
        onValue(ref(db, 'users/'), (snap) => {
            const users = snap.val();
            for(let id in users) {
                if(id !== myName) {
                    if(!markers[id]) markers[id] = L.marker([users[id].lat, users[id].lng]).addTo(map).bindPopup(id);
                    else markers[id].setLatLng([users[id].lat, users[id].lng]);
                }
            }
        });
    }

    // NAVEGACIÃ“N
    window.changeView = (id, btnId) => {
        document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
        document.querySelectorAll('.nav-i').forEach(b => b.classList.remove('active'));
        document.getElementById(id).classList.add('active');
        document.getElementById(btnId).classList.add('active');
        if(id === 'map-view' && map) setTimeout(() => map.invalidateSize(), 200);
    };

    document.getElementById('btn-v-map').onclick = () => changeView('map-view', 'btn-v-map');
    document.getElementById('btn-v-market').onclick = () => changeView('market-view', 'btn-v-market');
    document.getElementById('btn-v-chat').onclick = () => changeView('chat-view', 'btn-v-chat');

</script>
</body>
</html>
